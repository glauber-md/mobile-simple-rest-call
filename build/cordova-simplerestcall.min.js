// mobile-simple-rest-call - 2018-02-08 - Licenced under GPL-3.0
// Copyright (C) 2018 Glauber M. Dantas (opensource@glauber.me)
"use strict";var local_cache=function(){var e="BrowserCache",t=function(t,n,o){dbmgr.count(e,"WHERE resource = '"+t+"'",function(e){var t=!1;e>0&&(t=!0),n(t)},o)};return{set:function(n,o,i,c,s,u){t(n,function(t){t?(common_utils.log("[Cache] Updating URL "+n),dbmgr.update(e,{etag:i,payload:o,lastModified:c},"WHERE resource = '"+n+"'")):(common_utils.log("[Cache] Adding URL "+n),dbmgr.insert(e,{etag:i,resource:n,payload:o,lastModified:c},s,u))})},get:function(t,n,o){common_utils.log("[Cache] Getting URL "+t),dbmgr.select(e,"WHERE resource = '"+t+"'",function(e){n(e[0])},o)},exists:t}}(),dbmgr=function(e){var t=null;if(common_utils.isNull(e))t={db_name:"app-web-core.db",db_engine:"SQLITE",db_transIntervalMs:200};else t=e;var n=function(e,n){window.sqlitePlugin&&window.sqlitePlugin.openDatabase({name:t.db_name,iosDatabaseLocation:"default"},function(t){common_utils.log("[DB] Opening OK"),e(t)},function(e){common_utils.log("[DB] Opening ERROR: "+e.message),n(e)})};return{select:function(e,o,i,c){common_utils.log("[DB] Executing SELECT"),setTimeout(function(){var t="SELECT * FROM "+e;common_utils.isString(o)&&0==o.toLowerCase().indexOf("where")&&(t+=" "+o),n(function(e){e.executeSql(t,[],function(e){for(var t=[],n=0;n<e.rows.length;n++)t.push(e.rows.item(n));i(t)},function(e){common_utils.log("[DB] SELECT statement ERROR: "+e.message),c(e)})},c)},2*t.db_transIntervalMs)},insert:function(e,o,i,c){if(common_utils.log("[DB] Executing INSERT"),common_utils.isNull(o)||Object.keys(o).length<=0)throw"You must provide data to INSERT";setTimeout(function(){n(function(t){var n=Object.keys(o),s="INSERT INTO "+e+" ("+n.join()+") ",u=[],a=[];n.forEach(function(e,t){u.push("?"),a.push(o[e])}),s+="VALUES ("+u.join()+")",t.executeSql(s,a,function(e){var t=e.rowsAffected;common_utils.log("[DB] INSERT rowsAffected: "+t),i(t)},function(e){common_utils.log("[DB] INSERT statement ERROR: "+e.message),c(e)})},c)},t.db_transIntervalMs)},update:function(e,o,i,c,s){common_utils.log("[DB] Executing UPDATE"),setTimeout(function(){var t="UPDATE "+e+" SET ",u=[],a=[];Object.keys(o).forEach(function(e,t){u.push(e+" = ?"),a.push(o[e])}),t+=" "+u.join(),common_utils.isString(i)&&0==i.toLowerCase().indexOf("where")&&(t+=" "+i),n(function(e){e.executeSql(t,a,function(e){var t=e.rowsAffected;common_utils.log("[DB] UPDATE rowsAffected: "+t),c(t)},function(e){common_utils.log("[DB] UPDATE statement ERROR: "+e.message),s(e)})},s)},t.db_transIntervalMs)},delete:function(e,o,i,c){common_utils.log("[DB] Executing DELETE"),setTimeout(function(){var t="DELETE FROM "+e;if(!common_utils.isString(o)||0!=o.toLowerCase().indexOf("where"))throw"You must provide a WHERE clause";t+=" "+o,n(function(e){e.executeSql(t,[],function(e){var t=e.rowsAffected;common_utils.log("[DB] DELETE rowsAffected: "+t),i(t)},function(e){common_utils.log("[DB] DELETE statement ERROR: "+e.message),c(e)})},c)},t.db_transIntervalMs)},count:function(e,o,i,c){common_utils.log("[DB] Executing COUNT"),setTimeout(function(){var t="SELECT COUNT(*) AS count FROM "+e;common_utils.isString(o)&&0==o.toLowerCase().indexOf("where")&&(t+=" "+o),n(function(e){e.executeSql(t,[],function(e){var t=e.rows.item(0).count;common_utils.log("[DB] count: "+t),i(t)},function(e){common_utils.log("[DB] COUNT statement ERROR: "+e.message),c(e)})},c)},t.db_transIntervalMs)},init:function(){common_utils.log("[DB] Executing initialization scripts"),document.addEventListener("deviceready",function(){n(function(e){e.sqlBatch(["PRAGMA auto_vacuum = FULL","CREATE TABLE IF NOT EXISTS Parameter( key VARCHAR2(50), value TEXT, date TIMESTAMP DEFAULT CURRENT_TIMESTAMP )","CREATE UNIQUE INDEX IF NOT EXISTS paramKeyIdx ON Parameter( key ASC )","CREATE TABLE IF NOT EXISTS BrowserCache( etag VARCHAR2(50), resource VARCHAR2(255), payload TEXT, lastModified VARCHAR2(50), date TIMESTAMP DEFAULT CURRENT_TIMESTAMP )","CREATE UNIQUE INDEX IF NOT EXISTS cacheUrlIdx ON BrowserCache( resource ASC )"],function(){common_utils.log("[DB] Initialization OK")},function(e){common_utils.log("[DB] Initialization ERROR: "+e.message)})})})},test:function(){common_utils.log("[DB] Executing test scripts"),document.addEventListener("deviceready",function(){window.sqlitePlugin.echoTest(function(){common_utils.log("[DB] ECHO test OK")}),window.sqlitePlugin.selfTest(function(){common_utils.log("[DB] SELF test OK")})})}}}(),params=function(){var e="Parameter",t=function(t,n,o){dbmgr.count(e,"WHERE key = '"+t+"'",function(e){var t=!1;e>0&&(t=!0),n(t)},o)};return{set:function(n,o,i,c){t(n,function(t){t?(common_utils.log("[Params] Updating param "+n),dbmgr.update(e,{value:o,date:(new Date).toJSON()},"WHERE key = '"+n+"'")):(common_utils.log("[Params] Adding param "+n),dbmgr.insert(e,{key:n,value:o},i,c))})},get:function(t,n,o){common_utils.log("[Params] Getting param "+t),dbmgr.select(e,"WHERE key = '"+t+"' ORDER BY date DESC",function(e){n(e[0])},o)},exists:t}}(),wscall=function(e){var t=null,n={crossDomain:(t=common_utils.isNull(void 0)?{timeout:6e4,xsdomain:!0,cacheable:!0,contentType:"application/json; charset=UTF-8",dataType:"json"}:void 0).xsdomain,timeout:t.timeout,jsonp:!1,dataType:t.dataType,contentType:t.contentType,async:!0,cache:t.cacheable,statusCode:{500:function(e,t,n){common_utils.log("The operation could not be completed due to an error. Please try again later. "+JSON.stringify(e))},504:function(e,t,n){common_utils.log("The operation could not be completed due to an issue communicating with server. Please try again later. "+JSON.stringify(e))}}};return{get:function(e,o,i,c){var s=JSON.stringify(o);common_utils.log("[WS] GET -> URL: "+e+"; Data: "+s);var u=e+s;!0===t.cacheable?local_cache.exists(u,function(t){t?local_cache.get(u,function(t){$.ajax($.extend(n,{type:"GET",url:e,data:o,beforeSend:function(e){return e.setRequestHeader("If-Modified-Since",t.lastModified),e.setRequestHeader("If-None-Match",t.etag),!0},complete:function(e,t){if(common_utils.log("GET result: ("+t+") "+e.responseText),"notmodified"===t)local_cache.exists(u,function(t){t?local_cache.get(u,function(e){i(e.payload)}):i(e.responseText)},function(e){c(e)});else{var n=e.getResponseHeader("ETag"),o=e.getResponseHeader("Last-Modified");common_utils.isNull(n)||common_utils.isNull(o)||local_cache.set(u,e.responseText,n,o),i(e.responseText)}}}))},function(e){c(e)}):$.ajax($.extend(n,{type:"GET",url:e,data:o,beforeSend:function(e){return!0},complete:function(e,t){common_utils.log("GET result: ("+t+") "+e.responseText);var n=e.getResponseHeader("ETag"),o=e.getResponseHeader("Last-Modified");common_utils.isNull(n)||common_utils.isNull(o)||local_cache.set(u,e.responseText,n,o),i(e.responseText)}}))},function(e){c(e)}):$.ajax($.extend(n,{type:"GET",url:e,data:o,beforeSend:function(e){return!0},complete:function(e,t){common_utils.log("GET result (not cached): ("+t+") "+e.responseText),i(e.responseText)}}))},post:function(e,t,o,i){var c=JSON.stringify(t);common_utils.log("[WS] POST -> URL: "+e+"; Data: "+c),$.ajax($.extend(n,{type:"POST",url:e,data:t,beforeSend:function(e){return!0},complete:function(e,t){common_utils.log("POST result: ("+t+") "+e.responseText),o(e.responseText)}}))},delete:function(e,t,o,i){var c=JSON.stringify(t);common_utils.log("[WS] DELETE -> URL: "+e+"; Data: "+c);var s=e;common_utils.isNull(t)||(s=e+"?"+$.param(t)),$.ajax($.extend(n,{type:"DELETE",url:s,beforeSend:function(e){return!0},complete:function(e,t){common_utils.log("DELETE result: ("+t+") "+e.responseText),o(e.responseText)}}))},put:function(e,t,o,i){var c=JSON.stringify(t);common_utils.log("[WS] PUT -> URL: "+e+"; Data: "+c),$.ajax($.extend(n,{type:"PUT",url:e,data:t,beforeSend:function(e){return!0},complete:function(e,t){common_utils.log("PUT result: ("+t+") "+e.responseText),o(e.responseText)}}))}}}(),common_utils=function(){var e=app_config,t=function(e){var t=!1;return void 0!==e&&null!==e&&void 0!==e||(t=!0),t},n=function(e,t){navigator.notification?navigator.notification.alert(t,null,e,"OK"):n(t)};return{isNull:t,isString:function(e){var n=!1;return t(e)||"string"!=typeof e||(n=!0),n},isNumber:function(e){var n=!1;return t(e)||"number"!=typeof e||(n=!0),n},log:function(n){e.log.enable&&!t(n)&&(n.length>256&&(n=n.substring(0,256)+"/!/TEXT_WAS_TRUNCATED/!/"),(new Date).toJSON())},alert:n}}(),format_utils={toDecimal:function(e,t){var n=e,o=6;if(common_utils.isNull(t)||(o=t),common_utils.isNumber(e))Number.isInteger(e)||(n=e.toPrecision(o));else if(common_utils.isString(e)){var i=e;if(i.search(".")>-1){var c=i.split("."),s=c[0].length;if(s+c[1].length>6){var u=(c[0]+c[1]).substr(0,o);n=u.length>s?u.substr(0,s)+"."+u.substr(s,u.length-s):c[0]}}}return n}},system_utils=function(){var e=null,t=null,n=function(){if(navigator.connection)try{common_utils.isNull(e)&&((e={})[Connection.UNKNOWN]="Unknown",e[Connection.ETHERNET]="Ethernet",e[Connection.WIFI]="WiFi",e[Connection.CELL_2G]="Cell 2G",e[Connection.CELL_3G]="Cell 3G",e[Connection.CELL_4G]="Cell 4G",e[Connection.CELL]="Cell",e[Connection.NONE]="Not connected")}catch(e){common_utils.log(e)}device&&common_utils.isNull(t)&&((t={}).platform=device.platform+" "+device.version+"/"+device.model,t.id=device.uuid,t.imei=device.serial,t.emulated=device.isVirtual)},o=function(){var e={version:"UNKNOWN",name:"UNKNOWN",bundle:"UNKNOWN"};return cordova.getAppVersion&&(cordova.getAppVersion.getVersionNumber(function(t){e.version=t}),cordova.getAppVersion.getAppName(function(t){e.name=t}),cordova.getAppVersion.getPackageName(function(t){e.bundle=t})),e};return{getAppInfo:o,getInfo:function(){n();var i=o();return i.bundle+" "+i.version+" ("+t.platform+") ["+function(){n();var t="UNKNOWN";return navigator.connection&&(t=e[navigator.connection.type]),t}()+"]"},getPlatformName:function(){var e="UNKNOWN";return device&&(e=device.platform),String(e).toLowerCase()},getUniqueId:function(){return n(),t.platform+"#"+t.id}}}();